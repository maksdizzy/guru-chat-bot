# Story 1.1: RAG API Client Infrastructure

## Status
Ready for Review

## Story
**As a** developer,
**I want** a robust API client for the RAG endpoint,
**so that** the chatbot can reliably communicate with the external knowledge base.

## Acceptance Criteria
1. API client handles requests to `https://flowapi-dexguru.dexguru.biz/api/rag_search_telegram_es_db`
2. Client implements proper error handling and timeout mechanisms
3. Client supports configurable group_id parameter (default: 2493387211)
4. Response parsing correctly handles both llm_answer and sources array structure

## Tasks / Subtasks
- [x] Task 1: Create RAG client module structure (AC: 1, 3)
  - [x] Create directory `/lib/rag/` for RAG integration code
  - [x] Create main client file `/lib/rag/client.ts`
  - [x] Define TypeScript interfaces for RAG request/response types
- [x] Task 2: Implement API client core functionality (AC: 1, 3, 4)
  - [x] Create async function for RAG endpoint communication using fetch API
  - [x] Implement configurable parameters (group_id, query, max_results)
  - [x] Add proper request headers and Content-Type application/json
  - [x] Parse response JSON and validate structure against TypeScript interfaces
- [x] Task 3: Add error handling and resilience (AC: 2)
  - [x] Implement timeout mechanism (default 30 seconds, configurable)
  - [x] Add retry logic with exponential backoff (max 3 retries)
  - [x] Create custom error types for RAG-specific failures
  - [x] Integrate with existing ChatSDKError error system
- [x] Task 4: Add environment configuration (AC: 3)
  - [x] Add RAG_ENDPOINT_URL to environment variables
  - [x] Add RAG_DEFAULT_GROUP_ID to environment variables (default: 2493387211)
  - [x] Update `.env.example` with new environment variables
  - [x] Create configuration loader in client module
- [x] Task 5: Create unit tests for RAG client (AC: 1, 2, 3, 4)
  - [x] Set up test file `/lib/rag/client.test.ts`
  - [x] Mock fetch API for testing
  - [x] Test successful API calls
  - [x] Test error handling scenarios
  - [x] Test timeout behavior
  - [x] Test retry logic

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story in the project.

### Data Models
**RAG Response Structure** [Source: docs/prd.md#Technical-Verification]:
```typescript
interface RAGResponse {
  llm_answer: string;
  sources: RAGSource[];
}

interface RAGSource {
  msg_id: string;
  user_name: string;
  msg_date: string;
  msg_text: string;
}
```

### API Specifications
**External RAG Endpoint** [Source: docs/prd.md#FR3]:
- URL: `https://flowapi-dexguru.dexguru.biz/api/rag_search_telegram_es_db`
- Method: POST
- Authentication: None required (verified)
- Request format: JSON with query and group_id parameters
- Response format: JSON with llm_answer and sources array

**Existing Chat API Pattern** [Source: brownfield-architecture/data-models-and-apis.md#Chat-API]:
- Uses Server-sent events with AI SDK data protocol
- Rate limiting: 20/day (guest), 100/day (registered)
- Max duration: 60 seconds timeout
- Located at: `app/(chat)/api/chat/route.ts`

### Component Specifications
No UI components required for this backend-only story.

### File Locations
**New files to create** [Source: brownfield-architecture/source-tree-and-module-organization.md]:
- `/lib/rag/` - New directory for RAG integration (follows pattern of `/lib/ai/` for AI integration)
- `/lib/rag/client.ts` - Main RAG client implementation
- `/lib/rag/types.ts` - TypeScript type definitions
- `/lib/rag/client.test.ts` - Unit tests for RAG client

**Files to modify**:
- `.env.example` - Add new environment variables
- `.env.local` - Add actual environment variable values (local development)

### Testing Requirements
**Current Testing Reality** [Source: brownfield-architecture/testing-reality.md]:
- No unit test framework currently configured (0% coverage)
- E2E tests use Playwright with command: `export PLAYWRIGHT=True && pnpm exec playwright test`
- Manual testing is primary QA method
- **Note**: Unit tests requested in tasks but no testing framework exists - developer should either:
  1. Skip unit tests and document in completion notes
  2. Set up a basic testing framework (Jest/Vitest) if time permits
  3. Create tests as documentation for future implementation

### Technical Constraints
**Error Handling** [Source: brownfield-architecture/integration-points-and-external-dependencies.md#Internal-Integration-Points]:
- Use existing `ChatSDKError` class from `lib/errors.ts` for user-friendly error messages
- Follow existing error reporting patterns in the codebase

**Tech Stack Constraints** [Source: brownfield-architecture/high-level-architecture.md#Actual-Tech-Stack]:
- TypeScript 5.6.3 with strict mode enabled
- Node.js 20.x runtime
- Use native fetch API (available in Node.js 20.x)

### Testing
**Testing Standards** [Source: brownfield-architecture/testing-reality.md]:
- Test file location: Create in same directory as source with `.test.ts` extension
- Test framework: Currently not configured - document tests for future implementation
- Testing patterns: Follow existing E2E test patterns if applicable
- Specific requirements: Ensure RAG client failures don't crash the main chat service

## Change Log
| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-13 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
None - no critical issues encountered during development

### Completion Notes List
- All tasks completed successfully
- RAG client module implements full requirements per acceptance criteria
- Unit tests documented for future testing framework implementation
- TypeScript types properly defined and validated
- Environment configuration added to .env.example
- Error handling integrated with existing ChatSDKError system
- Note: No testing framework currently configured in project - tests serve as documentation

### File List
**New files created:**
- `lib/rag/types.ts` - TypeScript type definitions for RAG client
- `lib/rag/client.ts` - Main RAG client implementation with all required functionality
- `lib/rag/client.test.ts` - Unit test documentation (ready for testing framework)

**Files modified:**
- `.env.example` - Added RAG environment configuration variables

## QA Results
_To be populated by QA agent_